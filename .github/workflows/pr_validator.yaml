name: "pr-validator"
on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  swiftlint:
    name: Swiftlint
    runs-on: apps-ci
    timeout-minutes: 120
    steps:

    - name: Remove any previous hook ğŸ¥¸
      run: rm -rf .git/hooks

    - name: Checkout ğŸ”
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Rake âš™ï¸
      run: rake

    - name: Swiftlint ğŸ‘€
      run: |
        set -o pipefail && mint run swiftlint --strict \
        | sed -E 's/^(.*):([0-9]+):([0-9]+): (warning|error|[^:]+): (.*)/::\4 file=\1,line=\2,col=\3::\5/'

  build:
    name: Test
    runs-on: apps-ci
    timeout-minutes: 120
    steps:

    - name: Remove any previous hook ğŸ¥¸
      run: rm -rf .git/hooks

    - name: Checkout ğŸ”
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Rake âš™ï¸
      run: rake

    - name: Run tests âš™ï¸
      run: rake test

    - name: Save Output ğŸ“¦
      uses: actions/upload-artifact@v4
      with:
        name: output
        path: ${{ github.workspace }}/report.lcov
